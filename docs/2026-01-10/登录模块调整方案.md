# 登录模块调整方案（2026-01-10）

## 目标

1. 隐藏手机号登录、微信登录入口，仅保留邮箱登录与用户名登录。
2. 注册流程改为邮箱验证码注册：向邮箱发送验证码，输入验证码校验通过后方可注册。
3. 增加登录日志表：记录每次登录尝试的 IP、时间等信息，便于审计与排障。

## 现状梳理（基于当前代码）

### 前端

- 登录页使用 Tabs 展示多种登录方式：邮箱、用户名、手机、微信扫码
  - 参考：[Login.tsx](file:///root/aioffer/frontend/src/pages/Login.tsx)
- 注册页为基础用户名/邮箱/密码注册
  - 参考：[Register.tsx](file:///root/aioffer/frontend/src/pages/Register.tsx)
- 前端认证请求封装与接口定义
  - 参考：[auth.ts](file:///root/aioffer/frontend/src/services/auth.ts)

### 后端

- 登录与注册接口集中在 `routers/auth.py`
  - 参考：[auth.py](file:///root/aioffer/backend/routers/auth.py)
- 当前登录支持：email/username/phone/wechat
- 当前注册支持：email/phone/wechat（但未实现邮箱验证码校验）
- 多登录方式凭据表 `user_auths`
  - 参考：[UserAuth 模型](file:///root/aioffer/backend/models/user.py#L55-L95)

## 方案设计

### 1) 隐藏并禁用手机号、微信登录

#### 1.1 前端改造点

- 登录页 Tabs 仅保留：
  - 邮箱登录（email）
  - 用户名登录（username）
- 移除/禁用以下 UI 与逻辑：
  - 手机验证码发送按钮、倒计时、手机验证码登录表单
  - 微信二维码获取、轮询扫码状态、微信登录 Tab
- `services/auth.ts` 中 `LoginParams['auth_type']` 收窄为 `email | username`；微信/手机相关方法不再被页面使用。

#### 1.2 后端防绕过（必须）

即使前端隐藏入口，也需要后端拒绝相关登录类型，避免被直接调用绕过。

- `/api/auth/login`
  - 当 `auth_type in ('phone', 'wechat', 'wechat_qr')` 时返回错误（建议 HTTP 400），提示“暂不支持该登录方式”。
- `/api/auth/register`
  - 注册只允许邮箱验证码注册（见下一节），`auth_type` 维持兼容字段但逻辑上只允许 email。

### 2) 邮箱验证码注册（必须验证后创建用户）

#### 2.1 流程

1. 用户输入邮箱 → 点击“发送验证码”
2. 前端请求 `POST /api/auth/email/send-code`
3. 后端生成 6 位验证码：
   - 只保存验证码 hash，不保存明文
   - 设置有效期（建议 10 分钟）
   - 写入验证码表
4. 后端通过 SMTP 发送邮件（异步发送，避免阻塞请求）
5. 用户输入验证码 + 用户名 + 密码 → 点击“注册”
6. 前端请求 `POST /api/auth/register`（携带 `email_code`）
7. 后端校验验证码通过后创建用户与认证记录（`users` + `user_auths`）

#### 2.2 接口契约（建议）

##### 2.2.1 发送验证码

- Method: `POST /api/auth/email/send-code`
- Request JSON：
  - `email: string`
  - `purpose: "register"`（预留扩展，如 reset_password）
- Response：
  - 使用现有标准响应结构，返回成功即可，不返回验证码

##### 2.2.2 注册

- Method: `POST /api/auth/register`
- Request JSON：
  - `username: string`
  - `email: string`
  - `password: string`
  - `email_code: string`
- Response（两种选项）：
  - 选项 A（推荐第一版）：返回 `{ user_id, username }`，注册后引导登录
  - 选项 B：注册成功后直接返回 token（注册即登录）

#### 2.3 数据表设计：email_verification_codes

新增表：`email_verification_codes`

- 核心字段：
  - `id`：主键
  - `email`：邮箱
  - `purpose`：用途（register/reset_password 等）
  - `code_hash`：验证码 hash（不可逆）
  - `salt`：盐（或改用 HMAC 方案，不单独存盐）
  - `expires_at`：过期时间
  - `used_at`：使用时间（null 表示未使用）
  - `attempt_count`：验证尝试次数
  - `send_ip`：发送时 IP（可选）
  - `created_at`：创建时间

- 业务规则建议：
  - 同一邮箱同一用途 60 秒内限制重复发送（防刷）
  - 验证码最大尝试次数 5 次，超过即作废
  - 校验“最新一条未使用且未过期”的验证码，避免多条并存产生歧义

#### 2.4 邮件发送与配置（SMTP）

- 配置使用 `.env`（不要提交敏感信息）：
  - `SMTP_HOST`
  - `SMTP_PORT`
  - `SMTP_USER`
  - `SMTP_PASSWORD`
  - `SMTP_FROM`
  - `SMTP_TLS`
- 发送方式：
  - 第一版建议使用 FastAPI `BackgroundTasks` + `smtplib`（依赖少、实现快）
  - 若后续需要队列、重试与削峰，再切到 Celery（项目已引入 celery 依赖）

### 3) 登录日志表（每次登录都记录）

#### 3.1 记录目标

记录每次登录尝试（成功与失败），用于审计、风控与排障。

#### 3.2 表结构：login_logs

新增表：`login_logs`

- 核心字段：
  - `id`：主键
  - `user_id`：用户 ID（失败时可能为空）
  - `identifier`：登录标识（用户输入的 email/username；不记录密码）
  - `auth_type`：登录方式（email/username）
  - `success`：是否成功
  - `failure_reason`：失败原因（可选，枚举/短字符串）
  - `ip`：客户端 IP
  - `user_agent`：UA（可选）
  - `created_at`：发生时间

- 索引建议：
  - `(user_id, created_at desc)`
  - `(ip, created_at desc)`
  - `(success, created_at desc)`

#### 3.3 落库时机（关键）

在 `/api/auth/login` 内部，无论成功还是失败都写入一条日志：

- 成功：在返回 tokens 前写入
- 失败：在返回错误响应前写入

IP 获取策略建议：

- 优先：`X-Forwarded-For`（反向代理/网关场景）
- 否则：`request.client.host`

## 改造范围（最小可交付）

### 前端

- `Login.tsx`：移除手机、微信登录入口与逻辑
- `Register.tsx`：增加邮箱验证码输入框、发送按钮与倒计时
- `services/auth.ts`：增加 `sendEmailCode`，收窄登录参数类型

### 后端

- `routers/auth.py`：
  - 禁用 phone/wechat/wechat_qr 登录
  - 增加发送邮箱验证码接口
  - 注册时强制校验 email_code
  - 登录时写入 login_logs
- `models/`：
  - 新增 `EmailVerificationCode`
  - 新增 `LoginLog`
- `schemas/auth.py`：
  - 增加发送验证码请求 schema
  - 注册请求增加 `email_code`

说明：当前工程使用 `Base.metadata.create_all` 初始化表（参考 [database.py](file:///root/aioffer/backend/config/database.py#L82-L85)），因此新增模型即可在启动时创建新表（若生产环境建议后续补迁移脚本）。

## 验收标准（可测试）

1. 登录页只显示“邮箱登录、用户名登录”，不出现“手机登录、微信登录”。
2. 调用 `/api/auth/login`：
   - 传 `auth_type=phone/wechat/wechat_qr` 必定失败并返回明确错误提示。
3. 注册流程：
   - 未发送验证码 / 验证码错误 / 验证码过期 → 注册失败
   - 验证码正确且未过期且未使用 → 注册成功并创建用户
4. 登录日志：
   - 每次登录尝试（成功或失败）均产生一条 `login_logs` 记录
   - 记录包含：IP、created_at、success、auth_type、identifier（不包含密码/验证码）

